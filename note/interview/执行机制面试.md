# JS执行机制面试:

## 吐槽

笔者经常被问一个问题，你知道 setTimeout、setImmediate、promise.then、process.nextTick 的执行顺序区别么？

笔者回答：我默认这样的问法，说明我们的宿主环境在node.js。

面试同学：这有什么关系么？你是不是理解错了？我只是让你说明下区别而已。

笔者心想：唉，说不会好了。反正就算我说的对，他也不会承认了。。。

## 正文:

遇到这样的问题，还是首先说明，这个问题产生的运行环境目前看来只能是node.js。

而这个问题的回答需要从两方面说:

1.它们属于什么?
2.它们分别在JS的什么阶段执行呢？

## 从属关系:

setTimeout、setImmediate属于node.js的Timer模块。

process.nextTick属于node.js的process模块。

promise.then属于ECMAScript的规范，在node.js中是由V8来执行该规范。

## 所处阶段:

setTimeout在事件循环的Timer阶段执行。

setImmediate在事件循环的check阶段执行。

process.nextTick在任意阶段最后时执行，包括任务队列。

promise.then是在job queue中。根据我们之前的学习，job queue其实属于微观队列，就是说，在一个同步任务执行完毕时，结束阶段，promise.then如果在job queue中，那么就轮到它执行了。~

## 分析开始：

有了这些东西之后，我们如何判断执行时间呢？

```JavaScript
setTimeout(() => {
  console.log('timeout')
}, 0)

setImmediate(() => {
  console.log('immediate')
})

Promise.resolve().then(() => {console.log('promise.then')})

process.nextTick(() => {
  console.log('process.nextTick')
})
```

OK，思考下上面的示例执行时间..

我默认有3分钟了哈:

```bash
# 可能情况 1：
$ process.nextTick
$ promise.then
$ timeout
$ immediate

# 可能情况 2：
$ process.nextTick
$ promise.then
$ immediate
$ timeout
```
